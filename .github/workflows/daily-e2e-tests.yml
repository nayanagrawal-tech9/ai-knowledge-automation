name: Daily E2E Test Automation with Allure Reporting

on:
  # Schedule to run daily at 4 PM IST (10:30 AM UTC)
  schedule:
    - cron: '30 10 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - login
          - weather-query
          - home-verification

env:
  # Environment variables
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  e2e-tests:
    name: E2E Tests with Allure Reporting
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repository
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies
      - name: 📦 Install Dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium
          
      # Install Allure CLI
      - name: 🔧 Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk
          curl -o allure-2.24.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -zxvf allure-2.24.0.tgz -C /opt/
          sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure
          allure --version

      # Set up test environment
      - name: ⚙️ Setup Test Environment
        run: |
          echo "TEST_EMAIL=${{ secrets.TEST_EMAIL }}" >> $GITHUB_ENV
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> $GITHUB_ENV
          echo "BASE_URL=https://ai-knowledge-chat-ui.vercel.app" >> $GITHUB_ENV
          echo "HEADLESS=true" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV

      # Run tests based on input or default to all
      - name: 🧪 Run E2E Tests
        id: run-tests
        run: |
          echo "🚀 Starting E2E Test Execution at $(date)"
          
          # Determine which tests to run
          TEST_SUITE="${{ github.event.inputs.test_suite || 'all' }}"
          
          if [ "$TEST_SUITE" = "login" ]; then
            echo "Running login tests only..."
            npm run test:allure
          elif [ "$TEST_SUITE" = "weather-query" ]; then
            echo "Running weather query tests only..."
            npx playwright test tests/auth/weather-query.spec.ts
          elif [ "$TEST_SUITE" = "home-verification" ]; then
            echo "Running home verification tests only..."
            npx playwright test tests/auth/home-verification.spec.ts
          else
            echo "Running all auth tests..."
            npm run test:auth
          fi
          
          echo "test_status=completed" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Generate Allure Report
      - name: 📊 Generate Allure Report
        if: always()
        run: |
          echo "📊 Generating Allure Report..."
          allure generate allure-results --clean -o allure-report
          echo "✅ Allure report generated successfully"
          
          # Get test results summary
          if [ -d "allure-results" ]; then
            TOTAL_TESTS=$(find allure-results -name "*-result.json" | wc -l)
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_ENV
            
            # Count passed/failed tests (simplified)
            PASSED_TESTS=$(grep -l '"status":"passed"' allure-results/*-result.json 2>/dev/null | wc -l || echo "0")
            FAILED_TESTS=$(grep -l '"status":"failed"' allure-results/*-result.json 2>/dev/null | wc -l || echo "0")
            
            echo "passed_tests=$PASSED_TESTS" >> $GITHUB_ENV
            echo "failed_tests=$FAILED_TESTS" >> $GITHUB_ENV
          else
            echo "total_tests=0" >> $GITHUB_ENV
            echo "passed_tests=0" >> $GITHUB_ENV
            echo "failed_tests=0" >> $GITHUB_ENV
          fi

      # Deploy Allure Report to GitHub Pages
      - name: 🚀 Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: allure-reports/${{ github.run_number }}
          keep_files: true

      # Get the deployed report URL
      - name: 🔗 Get Report URL
        if: always()
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-reports/${{ github.run_number }}"
          echo "report_url=$REPORT_URL" >> $GITHUB_ENV
          echo "📊 Allure Report URL: $REPORT_URL"

      # Archive test artifacts
      - name: 📁 Archive Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ github.run_number }}
          path: |
            allure-report/
            allure-results/
            test-results/
            *.png
          retention-days: 30

      # Send results to Slack
      - name: 📢 Send Results to Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          custom_payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL }}",
              "username": "E2E Test Bot",
              "icon_emoji": ":robot_face:",
              "attachments": [
                {
                  "color": "${{ env.failed_tests == '0' && 'good' || 'danger' }}",
                  "title": "🤖 Daily E2E Test Results",
                  "fields": [
                    {
                      "title": "📊 Test Summary",
                      "value": "Total: ${{ env.total_tests }} | ✅ Passed: ${{ env.passed_tests }} | ❌ Failed: ${{ env.failed_tests }}",
                      "short": false
                    },
                    {
                      "title": "🕒 Execution Time",
                      "value": "$(date +'%Y-%m-%d %H:%M:%S UTC')",
                      "short": true
                    },
                    {
                      "title": "🔗 Allure Report",
                      "value": "<${{ env.report_url }}|View Detailed Report>",
                      "short": true
                    },
                    {
                      "title": "🚀 Workflow Run",
                      "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View GitHub Action>",
                      "short": true
                    }
                  ],
                  "footer": "AI Knowledge Chat UI E2E Tests",
                  "footer_icon": "https://github.com/favicon.ico",
                  "ts": $(date +%s)
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Cleanup old reports (keep last 10)
  cleanup-reports:
    name: 🧹 Cleanup Old Reports
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          
      - name: 🗑️ Remove Old Reports
        run: |
          if [ -d "allure-reports" ]; then
            cd allure-reports
            # Keep only the latest 10 reports
            ls -1 | sort -n | head -n -10 | xargs -r rm -rf
            echo "✅ Cleaned up old reports, keeping latest 10"
          fi
          
      - name: 📤 Commit Cleanup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "🧹 Cleanup old Allure reports"
          git push
