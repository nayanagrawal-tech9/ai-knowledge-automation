name: Test Workflow Setup

on:
  # Manual trigger only for testing setup
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  setup-test:
    name: Test Workflow Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: |
          npm ci
          npx playwright install chromium

      - name: 🔧 Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk wget
          wget -q https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -zxf allure-2.24.0.tgz -C /opt/
          sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/bin/allure
          allure --version

      - name: ⚙️ Test Environment Setup
        run: |
          echo "Testing environment variables..."
          echo "TEST_EMAIL is $([ -n '${{ secrets.TEST_EMAIL }}' ] && echo 'configured' || echo 'missing')"
          echo "TEST_PASSWORD is $([ -n '${{ secrets.TEST_PASSWORD }}' ] && echo 'configured' || echo 'missing')"
          echo "SLACK_WEBHOOK_URL is $([ -n '${{ secrets.SLACK_WEBHOOK_URL }}' ] && echo 'configured' || echo 'missing')"
          
          # Set environment for tests
          echo "BASE_URL=https://ai-knowledge-chat-ui.vercel.app" >> $GITHUB_ENV
          echo "HEADLESS=true" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV

      - name: 🧪 Run Quick Test
        if: github.event.inputs.test_type == 'quick' || github.event.inputs.test_type == ''
        run: |
          echo "Running quick configuration test..."
          # Just verify the test framework works
          npx playwright test tests/auth/login.spec.ts --grep="should display login page elements correctly" || true

      - name: 🧪 Run Full Test
        if: github.event.inputs.test_type == 'full'
        run: |
          echo "Running full login test..."
          npm run test:allure || true

      - name: 📊 Generate Test Report
        if: always()
        run: |
          echo "Generating Allure report..."
          if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
            allure generate allure-results --clean -o allure-report
            echo "✅ Allure report generated"
            
            # Test results summary
            TOTAL_TESTS=$(find allure-results -name "*-result.json" | wc -l)
            echo "Found $TOTAL_TESTS test result files"
          else
            echo "⚠️ No allure-results found or directory empty"
            mkdir -p allure-report
            echo "<h1>No test results available</h1>" > allure-report/index.html
          fi

      - name: 📤 Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-setup-validation-${{ github.run_number }}
          path: |
            allure-report/
            allure-results/
            test-results/

      - name: 📱 Test Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          custom_payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL }}",
              "username": "E2E Setup Test Bot",
              "icon_emoji": ":test_tube:",
              "text": "🧪 **Workflow Setup Test Completed**",
              "attachments": [
                {
                  "color": "${{ job.status == 'success' && 'good' || 'warning' }}",
                  "fields": [
                    {
                      "title": "📋 Setup Status",
                      "value": "Workflow configuration test completed",
                      "short": false
                    },
                    {
                      "title": "🔗 View Details",
                      "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Action Run>",
                      "short": false
                    }
                  ],
                  "footer": "Setup validation completed at $(date)"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
